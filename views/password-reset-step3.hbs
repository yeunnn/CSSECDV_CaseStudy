<!DOCTYPE html>
<html lang="en" dir="ltr">

	<head>
	<meta charset="utf-8">

	<title>OSSU | {{#if user}}Change Password{{else}}Password Reset{{/if}}</title>

	<link rel="stylesheet" href="/css/login_signup.css">
	<link rel="icon" type="image/x-icon" href="/images/ossu-logo.png">
	
	<script src="https://kit.fontawesome.com/a076d05399.js"></script>

	</head>

	<body>
		<div class="bg-img">
			<div class="content" style="overflow: hidden">
				<header>{{#if user}}Change Password - New Password{{else}}Password Reset - New Password{{/if}}</header>
				<!-- Add this where you want the error message to appear -->
				{{#if errorMessage}}
					<div class="error-box">
						{{errorMessage}}
					</div>
				{{/if}}
				<form action="/password-reset-final" method="post">
					<div class="field">
						<span class="fa fa-user" style="flex: 1;">
                            <input type="text" value="{{username}}" name="username" readonly>
                        </span>
					</div>
					<br>
					<div class="field">
						<span class="fa fa-lock"></span>
						<input type="password" required placeholder="Enter New Password..." name="password" required>
					</div>
					<br>
					<div class="field">
						<span class="fa fa-lock"></span>
						<input type="password" required placeholder="Confirm New Password..." name="confirmPassword" required>
					</div>
					
					<div class="field">
						<input type="submit" value="{{#if user}}Change Password{{else}}Reset Password{{/if}}" name="submit">
					</div>
				</form>
				<br>
				{{#if user}}
					<!-- Navigation for logged-in users (Change Password flow) -->
					{{#ifCond position 'Customer'}}
						<a href="/index" class="return-home">Back to Dashboard</a>
					{{else}}
						<a href="/staff-page" class="return-home">Back to Dashboard</a>
					{{/ifCond}}
					<br>
					<a href="/logout" class="return-home">Cancel and Logout</a>
				{{else}}
					<!-- Navigation for anonymous users (Forgot Password flow) -->
					<a href="/" class="return-home">Back to Home</a>
					<br>
					<a href="/staff-login" class="return-home">Remember your password? Login</a>
				{{/if}}
			</div>
		</div>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const passwordInput = document.querySelector(".pass-key");
			const showButton = document.querySelector(".show");
			
			showButton.addEventListener("click", function () {
			if (passwordInput.type === "password") {
				passwordInput.type = "text";
			} else {
				passwordInput.type = "password";
			}
			});

			//const passwordChecker = document.getElementById('password');
			const minLength = document.getElementById('validatePL')
			const minLowercase = document.getElementById('validateLC')
			const minUppercase = document.getElementById('validateUC')
			const minNumeric = document.getElementById('validateNC')
		
			console.log(minLength.textContent);
			let timeoutId;

			passwordInput.addEventListener('input', () => {
				clearTimeout(timeoutId);
				timeoutId = setTimeout(() => {
					const password = passwordInput.value;

					//AJAX✅ 
					fetch('/validate-password', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json'},
						body: JSON.stringify({ password })
					})
					.then(res => res.json())
					.then(data => {
						console.log(data.validated);
						const response = data.validated;
						///PL, LC, UC, NC
						if(response[0] == true) {minLength.textContent = "✅";}
						else {minLength.textContent = "❌";}

						if(response[1] == true) {minLowercase.textContent = "✅";}
						else {minLowercase.textContent = "❌";}

						if(response[2] == true) {minUppercase.textContent = "✅";}
						else {minUppercase.textContent = "❌";}

						if(response[3] == true) {minNumeric.textContent = "✅";}
						else {minNumeric.textContent = "❌";}
					})
				}, 300)
			})
		});

		


	</script>

	</body>
</html>
