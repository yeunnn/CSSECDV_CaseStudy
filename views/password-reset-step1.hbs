<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>OSSU | {{#if user}}Change Password{{else}}Password Reset{{/if}}</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="/css/modern-auth.css">
	<link rel="icon" type="image/x-icon" href="/images/ossu-logo.png">
</head>

<body>
	<div class="auth-background">
		<div class="auth-container">
			<div class="auth-header">
				<h1>{{#if user}}Change Password - Enter Username{{else}}Password Reset - Enter Username{{/if}}</h1>
			</div>
			
			{{#if errorMessage}}
				<div class="error-box">
					{{errorMessage}}
				</div>
			{{/if}}

			<form class="auth-form" method="POST" action="/password-reset-2" novalidate>
				<div class="input-group">
					<label for="username">Username</label>
					<div class="input-field with-icon">
						<i class="input-icon fas fa-user"></i>
						<input type="text" 
						       id="username"
						       name="username" 
						       placeholder="Enter your username"
						       required 
						       maxlength="30"
						       minlength="3"
						       pattern="[a-zA-Z0-9_-]+"
						       title="Username must be 3-30 characters long and contain only letters, numbers, underscores, and hyphens">
					</div>
					<div class="char-counter" id="username-counter">0/30</div>
				</div>

				<div class="input-group">
					<input type="submit" value="Continue" name="submit" class="auth-submit-btn">
				</div>
			</form>

			{{#if user}}
				<!-- Navigation for logged-in users (Change Password flow) -->
				<div class="auth-navigation">
					{{#ifCond position 'Customer'}}
						<a href="/index" class="auth-nav-link">Back to Dashboard</a>
					{{else}}
						<a href="/staff-page" class="auth-nav-link">Back to Dashboard</a>
					{{/ifCond}}
					<a href="/logout" class="auth-nav-link">Logout</a>
				</div>
			{{else}}
				<!-- Navigation for anonymous users (Forgot Password flow) -->
				<div class="auth-navigation">
					<a href="/" class="auth-nav-link">Back to Home</a>
					<a href="/staff-login" class="auth-nav-link">Remember your password? Login</a>
				</div>
			{{/if}}
		</div>
	</div>

	<script src="/js/validation.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			// Password toggle functionality
			const togglePassword = document.getElementById('togglePassword');
			const passwordInput = document.getElementById('password');

			if (togglePassword && passwordInput) {
				togglePassword.addEventListener('click', function() {
					const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
					passwordInput.setAttribute('type', type);
					
					if (type === 'text') {
						this.innerHTML = '<i class="fas fa-eye-slash"></i> HIDE';
					} else {
						this.innerHTML = '<i class="fas fa-eye"></i> SHOW';
					}
				});
			}

			// Character counters
			const usernameInput = document.getElementById('username');
			const passwordInputForCounter = document.getElementById('password');
			const usernameCounter = document.getElementById('username-counter');
			const passwordCounter = document.getElementById('password-counter');

			if (usernameInput && usernameCounter) {
				usernameInput.addEventListener('input', function() {
					const length = this.value.length;
					const maxLength = this.getAttribute('maxlength');
					usernameCounter.textContent = `${length}/${maxLength}`;
					
					if (length > maxLength * 0.8) {
						usernameCounter.className = 'char-counter warning';
					} else if (length > maxLength * 0.9) {
						usernameCounter.className = 'char-counter danger';
					} else {
						usernameCounter.className = 'char-counter';
					}
				});
			}

			if (passwordInputForCounter && passwordCounter) {
				passwordInputForCounter.addEventListener('input', function() {
					const length = this.value.length;
					const maxLength = this.getAttribute('maxlength');
					passwordCounter.textContent = `${length}/${maxLength}`;
					
					if (length > maxLength * 0.8) {
						passwordCounter.className = 'char-counter warning';
					} else if (length > maxLength * 0.9) {
						passwordCounter.className = 'char-counter danger';
					} else {
						passwordCounter.className = 'char-counter';
					}
				});
			}

			// Initialize validation for this modern form
			if (window.initializeValidation) {
				window.initializeValidation();
			}
		});
	</script>
</body>
</html>
